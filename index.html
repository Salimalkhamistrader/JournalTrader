<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ú˜ÙˆØ±Ù†Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ XAUUSD â€” Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙØ¹Ø§Ù„)</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:18px;min-height:100vh}
        .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.25)}
        .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;padding:20px;text-align:center}
        .header h1{font-size:20px;margin-bottom:6px}
        .form-section{padding:18px}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-bottom:14px}
        .form-group{display:flex;flex-direction:column}
        label{font-weight:600;margin-bottom:6px;color:#2c3e50;font-size:13px}
        input,select,textarea{padding:10px;border:1.6px solid #e0e0e0;border-radius:8px;font-size:13px}
        .button-group{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
        button{padding:10px 16px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
        .btn-save{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
        .btn-update{background:#8e44ad;color:#fff}
        .btn-clear{background:#95a5a6;color:#fff}
        .btn-excel{background:#16a085;color:#fff}
        .btn-import{background:#3498db;color:#fff}
        .btn-pdf{background:#c0392b;color:#fff}
        .btn-sync{background:#2d9cdb;color:#fff}
        .sync-config{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
        .hint{font-size:12px;color:#666;margin-top:8px}
        .journal-table{padding:12px;overflow-x:auto}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th,td{padding:10px;text-align:right;border-bottom:1px solid #eaeaea}
        th{background:#f8f9fa;position:sticky;top:0;font-weight:700;color:#2c3e50}
        tr:hover{background:#f8f9fa}
        .selected-row{background:#e8f0fe !important}
        .delete-btn{background:#e74c3c;color:#fff;padding:6px 10px;border-radius:6px;border:none;cursor:pointer}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px}
        .stat-card{background:#fff;padding:10px;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.06)}
        .alert{padding:10px;border-radius:8px;margin-bottom:10px;font-weight:700}
        .alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .alert-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
        .alert-info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
        .small{padding:8px 10px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
        .config-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Ú˜ÙˆØ±Ù†Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ XAUUSD â€” Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙØ¹Ø§Ù„)</h1>
            <p>Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ + Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø¨Ø§ GitHub Gist</p>
        </div>

        <div class="form-section">
            <div id="alertContainer"></div>

            <h2 style="margin-bottom:10px;color:#2c3e50">Ø«Ø¨Øª / ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø¹Ø§Ù…Ù„Ù‡</h2>

            <div class="form-grid">
                <div class="form-group"><label>ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† *</label><input id="datetime" type="datetime-local" required></div>
                <div class="form-group"><label>Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡ *</label><select id="tradeType" required><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option value="Ø®Ø±ÛŒØ¯">Ø®Ø±ÛŒØ¯</option><option value="ÙØ±ÙˆØ´">ÙØ±ÙˆØ´</option></select></div>
                <div class="form-group"><label>Ù†Ù…Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ</label><select id="symbol"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>XAU/USD</option><option>EUR/USD</option><option>BTC/USDT</option><option>ETH/USDT</option></select></div>
                <div class="form-group"><label>Ù†ÙˆØ¹ Ø³ØªØ§Ù¾ *</label><select id="setupType" required><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>Ø´Ú©Ø³Øª Ø¬Ø¹Ù„ÛŒ</option><option>Ù¾ÙˆÙ„Ø¨Ú©</option><option>Ø±ÛŒÙˆØ±Ø³Ø§Ù„ Ø¨Ø§Ø±</option></select></div>

                <div class="form-group"><label>Ø±ÙˆÙ†Ø¯ M15 *</label><select id="trendM15" required><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>ØµØ¹ÙˆØ¯ÛŒ</option><option>Ù†Ø²ÙˆÙ„ÛŒ</option><option>Ø±Ù†Ø¬</option></select></div>
                <div class="form-group"><label>Ø±ÙˆÙ†Ø¯ M30</label><select id="trendM30"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>ØµØ¹ÙˆØ¯ÛŒ</option><option>Ù†Ø²ÙˆÙ„ÛŒ</option><option>Ø±Ù†Ø¬</option></select></div>
                <div class="form-group"><label>Ø±ÙˆÙ†Ø¯ H1</label><select id="trendH1"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>ØµØ¹ÙˆØ¯ÛŒ</option><option>Ù†Ø²ÙˆÙ„ÛŒ</option><option>Ø±Ù†Ø¬</option></select></div>
                <div class="form-group"><label>Ø±ÙˆÙ†Ø¯ H4</label><select id="trendH4"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>ØµØ¹ÙˆØ¯ÛŒ</option><option>Ù†Ø²ÙˆÙ„ÛŒ</option><option>Ø±Ù†Ø¬</option></select></div>

                <div class="form-group"><label>Ø±ÙˆÙ†Ø¯ D1</label><select id="trendD1"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>ØµØ¹ÙˆØ¯ÛŒ</option><option>Ù†Ø²ÙˆÙ„ÛŒ</option><option>Ø±Ù†Ø¬</option></select></div>
                <div class="form-group"><label>Ø±ÙˆÙ†Ø¯ MN</label><select id="trendMN"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>ØµØ¹ÙˆØ¯ÛŒ</option><option>Ù†Ø²ÙˆÙ„ÛŒ</option><option>Ø±Ù†Ø¬</option></select></div>
                <div class="form-group"><label>Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯</label><input id="entryPrice" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 2050.50"></div>
                <div class="form-group"><label>Ø­Ø¯ Ø¶Ø±Ø± (SL)</label><input id="stopLoss" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 2045.00"></div>

                <div class="form-group"><label>Ø­Ø¯ Ø³ÙˆØ¯ (TP)</label><input id="takeProfit" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 2058.00"></div>
                <div class="form-group"><label>Ø±ÛŒØ³Ú© (Ø¯Ù„Ø§Ø±) *</label><select id="riskAmount" required><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select></div>
                <div class="form-group"><label>Ù†Ø³Ø¨Øª Ø±ÛŒØ³Ú© Ø¨Ù‡ Ø±ÛŒÙˆØ§Ø±Ø¯ (R)</label><select id="riskReward"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>1</option><option>1.5</option><option>2</option><option>2.5</option><option>3</option></select></div>
                <div class="form-group"><label>Ù†ØªÛŒØ¬Ù‡ Ù…Ø¹Ø§Ù…Ù„Ù‡ *</label><select id="tradeResult" required><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>Ø³ÙˆØ¯</option><option>Ø¶Ø±Ø±</option><option>Ø³Ø±Ø¨Ù‡â€ŒØ³Ø±</option><option>Ø¨Ø§Ø²</option></select></div>

                <div class="form-group"><label>Ù…Ø¨Ù„Øº Ø³ÙˆØ¯/Ø¶Ø±Ø± (Ø¯Ù„Ø§Ø±)</label><input id="profitLoss" type="number" step="0.01" placeholder="+7.5 ÛŒØ§ -5"></div>
                <div class="form-group"><label>Ø­Ø§Ù„Øª Ø°Ù‡Ù†ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ù…Ø¹Ø§Ù…Ù„Ù‡ *</label><select id="mentalState" required><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>Ø¢Ø±Ø§Ù… Ùˆ Ù…ØªÙ…Ø±Ú©Ø²</option><option>Ø®ÙˆØ´Ø­Ø§Ù„</option><option>Ù†Ú¯Ø±Ø§Ù†</option><option>Ø§Ø³ØªØ±Ø³</option></select></div>
            </div>

            <div class="form-grid" style="margin-top:8px">
                <div class="form-group"><label>Ú†Ø±Ø§ ÙˆØ§Ø±Ø¯ Ø§ÛŒÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø´Ø¯Ù…ØŸ *</label><select id="reasonEntry" required>
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                    <option>Ø³Ø·Ø­ Ø­Ù…Ø§ÛŒØª/Ù…Ù‚Ø§ÙˆÙ…Øª Ù‚ÙˆÛŒ + ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø§ÛŒØ³ Ø§Ú©Ø´Ù†</option>
                    <option>Ø´Ú©Ø³Øª Ø¬Ø¹Ù„ÛŒ Ø¨Ø§ Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ + Ø±ÛŒÙˆØ±Ø³Ø§Ù„ Ø¨Ø§Ø±</option>
                    <option>Ù¾ÙˆÙ„Ø¨Ú© Ø¨Ù‡ Ø³Ø·Ø­ Ø´Ú©Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ø¯Ø± Ø±Ø§Ø³ØªØ§ÛŒ Ø±ÙˆÙ†Ø¯</option>
                </select></div>

                <div class="form-group"><label>Ø§Ø­Ø³Ø§Ø³Ø§Øª Ø¯Ø± Ø·ÙˆÙ„ Ù…Ø¹Ø§Ù…Ù„Ù‡</label><select id="emotions"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>Ø¢Ø±Ø§Ù… Ùˆ Ú©Ù†ØªØ±Ù„ Ú©Ø§Ù…Ù„</option><option>Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ù‡ Ù†ÙØ³ Ø¨Ø§Ù„Ø§</option><option>Ú©Ù…ÛŒ Ø§Ø³ØªØ±Ø³</option></select></div>

                <div class="form-group"><label>Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ù…Ù†</label><select id="mistakes"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>Ù‡ÛŒÚ† Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ</option><option>Ø®ÛŒÙ„ÛŒ Ø²ÙˆØ¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù…</option><option>Ø­Ø¯ Ø¶Ø±Ø± Ø®ÛŒÙ„ÛŒ Ú¯Ø´Ø§Ø¯ Ø¨ÙˆØ¯</option></select></div>

                <div class="form-group"><label>Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§Ø¨Ø¯ØŸ</label><select id="improvements"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option><option>ØµØ¨ÙˆØ±ØªØ± Ø¨Ø§Ø´Ù…</option><option>Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ø±Ùˆ Ø¬Ø¯ÛŒâ€ŒØªØ± Ø¨Ú¯ÛŒØ±Ù…</option></select></div>

                <div class="form-group" style="grid-column:1/-1">
                    <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                    <textarea id="description" rows="3" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª..."></textarea>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-save" onclick="saveTrade()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù…Ø¹Ø§Ù…Ù„Ù‡</button>
                <button class="btn-update" onclick="updateTrade()">ğŸ› ï¸ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡</button>
                <button class="btn-clear" onclick="clearForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
                <button class="btn-excel" onclick="exportToExcel()">ğŸ“Š Ø°Ø®ÛŒØ±Ù‡ Excel</button>
                <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Excel</button>
                <button class="btn-pdf" onclick="exportToPDF()">ğŸ“• Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
            </div>

            <!-- Sync UI -->
            <div style="margin-top:14px;border-top:1px dashed #eee;padding-top:12px">
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                    <strong>Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ GitHub Gist (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</strong>
                    <button class="btn-sync" onclick="saveToGist()">â¬†ï¸ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Gist</button>
                    <button class="btn-sync" onclick="loadFromGist()">â¬‡ï¸ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Gist</button>
                    <button class="btn-sync" onclick="createGist()">ğŸ†• Ø§ÛŒØ¬Ø§Ø¯ Gist Ø¬Ø¯ÛŒØ¯</button>
                </div>

                <div class="sync-config">
                    <input id="gistToken" placeholder="ØªÙˆÚ©Ù† GitHub (personal access token)" type="password" />
                    <input id="gistId" placeholder="Gist ID (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" />
                    <button class="small" onclick="saveGistConfig()">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
                    <button class="small" onclick="clearGistConfig()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
                </div>

                <div class="config-row">
                    <label style="font-weight:700">Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±:</label>
                    <!-- Ù‡Ø± Ø¯Ùˆ ØªÛŒÚ© Ù¾ÛŒØ´â€ŒÙØ±Ø¶ checked Ù‡Ø³ØªÙ†Ø¯Ø› JS Ù†ÛŒØ² Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ Ø¢Ù† Ø±Ø§ true Ø¯Ø± Ù†Ø¸Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ -->
                    <label><input id="autoPush" type="checkbox" checked> Autoâ€‘push (Ø¢Ù¾Ù„ÙˆØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡/ÙˆÛŒØ±Ø§ÛŒØ´)</label>
                    <label><input id="autoPull" type="checkbox" checked> Autoâ€‘pull (Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø§Ø² Gist)</label>
                    <label>ÙØ§ØµÙ„Ù‡ Pull (Ø¯Ù‚ÛŒÙ‚Ù‡): <input id="pullInterval" type="number" min="1" value="5" style="width:70px;padding:6px;border-radius:6px;border:1px solid #ddd"></label>
                    <button class="small" onclick="saveGistConfig()">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
                </div>

                <div class="hint">Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±ØŒ ØªÙˆÚ©Ù† Ø¨Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ gist Ù„Ø§Ø²Ù… Ø§Ø³Øª. Autoâ€‘push Ù¾Ø³ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡/ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Autoâ€‘pull Ø¨Ù‡ ØµÙˆØ±Øª Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡) Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
            </div>

            <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" onchange="importFromExcel(event)">
        </div>

        <div class="form-section">
            <h2 class="section-title">Ø¢Ù…Ø§Ø± Ùˆ ÙÛŒÙ„ØªØ± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</h2>

            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
                <label>Ø§Ø²: <input id="fromDate" type="date" class="small"></label>
                <label>ØªØ§: <input id="toDate" type="date" class="small"></label>
                <button class="small" onclick="applyFilter()">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
                <button class="small" onclick="resetFilter()">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡</button>
                <div id="currentFilter" style="margin-right:10px;color:#2c3e50;font-weight:700"></div>
            </div>

            <div class="stats" id="stats">
                <div class="stat-card"><h4>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h4><p id="totalTrades">0</p></div>
                <div class="stat-card"><h4>Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø³ÙˆØ¯Ø¯Ù‡</h4><p id="winningTrades" class="profit">0</p></div>
                <div class="stat-card"><h4>Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¶Ø±Ø±Ø¯Ù‡</h4><p id="losingTrades" class="loss">0</p></div>
                <div class="stat-card"><h4>Ù†Ø±Ø® Ø¨Ø±Ø¯ (%)</h4><p id="winRate">0%</p></div>
                <div class="stat-card"><h4>Ø³ÙˆØ¯/Ø¶Ø±Ø± Ø¨Ø§Ø²Ù‡</h4><p id="totalPL">$0</p></div>
            </div>

            <h2 class="section-title">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>
            <div class="journal-table">
                <table>
                    <thead>
                        <tr>
                            <th>ØªØ§Ø±ÛŒØ®</th><th>Ù†ÙˆØ¹</th><th>Ù†Ù…Ø§Ø¯</th><th>Ø³ØªØ§Ù¾</th><th>M15</th><th>M30</th><th>H1</th><th>H4</th><th>D1</th><th>MN</th><th>Ø±ÛŒØ³Ú©</th><th>R:R</th><th>Ù†ØªÛŒØ¬Ù‡</th><th>Ø³ÙˆØ¯/Ø¶Ø±Ø±</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTable">
                        <tr><td colspan="16" style="text-align:center;padding:40px;color:#95a5a6">Ù‡Ù†ÙˆØ² Ù…Ø¹Ø§Ù…Ù„Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
/* ============================
   ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
   ============================ */
let trades = [];
let filteredTrades = null;
let selectedRowId = null;

/* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ */
let autoPushTimer = null;   // Ø¨Ø±Ø§ÛŒ debounce push
let autoPullIntervalId = null; // Ø¨Ø±Ø§ÛŒ interval pull
const PUSH_DEBOUNCE_MS = 1200; // Ù¾Ø³ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡/ÙˆÛŒØ±Ø§ÛŒØ´ ØµØ¨Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø³Ù¾Ø³ push Ù…ÛŒâ€ŒÚ©Ù†Ø¯
const DEFAULT_PULL_MINUTES = 5;

/* ======= Ù‚Ø§Ù„Ø¨ ØªØ§Ø±ÛŒØ®/Ø²Ù…Ø§Ù† ÛŒÚ©Ù†ÙˆØ§Ø®Øª ======= */
const DATE_TIME_OPTIONS = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false };
function formatDateTime(value){
    if(!value) return '';
    // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø§Ø² Ù†ÙˆØ¹ Date ÛŒØ§ Ø±Ø´ØªÙ‡ ISO Ø¨Ø§Ø´Ø¯ØŒ ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†
    let d;
    if(value instanceof Date) d = value;
    else d = new Date(value);
    if(isNaN(d.getTime())) return String(value);
    try{
        return d.toLocaleString('fa-IR', DATE_TIME_OPTIONS);
    }catch(e){
        // fallback
        return d.toLocaleString();
    }
}

/* ======= Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ======= */
function loadTrades(){
    const saved = localStorage.getItem('xauusdTrades');
    if(saved){
        try{ trades = JSON.parse(saved); } catch(e){ trades = []; }
    }

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª gist
    const token = localStorage.getItem('xau_gist_token') || '';
    const gistId = localStorage.getItem('xau_gist_id') || '';
    document.getElementById('gistToken').value = token;
    document.getElementById('gistId').value = gistId;

    // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ ØªÙ†Ø¸ÛŒÙ…ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Auto push/pull Ø±Ø§ ÙØ¹Ø§Ù„ Ø¯Ø± Ù†Ø¸Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
    const storedAutoPush = localStorage.getItem('xau_auto_push');
    const storedAutoPull = localStorage.getItem('xau_auto_pull');
    const storedPullInterval = localStorage.getItem('xau_pull_interval');

    const autoPush = (storedAutoPush === null) ? true : (storedAutoPush === '1');
    const autoPull = (storedAutoPull === null) ? true : (storedAutoPull === '1');
    const pullInterval = parseInt(storedPullInterval || DEFAULT_PULL_MINUTES, 10);

    // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø± localStorage ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ Ø¯Ø± localStorage Ù‡Ù… Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
    if(storedAutoPush === null) localStorage.setItem('xau_auto_push','1');
    if(storedAutoPull === null) localStorage.setItem('xau_auto_pull','1');
    if(storedPullInterval === null) localStorage.setItem('xau_pull_interval', String(pullInterval));

    document.getElementById('autoPush').checked = autoPush;
    document.getElementById('autoPull').checked = autoPull;
    document.getElementById('pullInterval').value = pullInterval;

    // Ø§Ú¯Ø± autoPull ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ø´Ø±ÙˆØ¹ Ú©Ù†
    if(autoPull) startAutoPull(pullInterval);

    updateTable(); updateStats();
}

/* ======= Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… ======= */
function showAlert(message, type='success'){
    const container = document.getElementById('alertContainer');
    const div = document.createElement('div');
    div.className = 'alert ' + (type==='success' ? 'alert-success' : type==='info' ? 'alert-info' : 'alert-error');
    div.textContent = message;
    container.appendChild(div);
    setTimeout(()=>div.remove(),4500);
}

/* ======= ÙØ±Ù… ======= */
function readForm(){
    return {
        datetime: document.getElementById('datetime').value,
        tradeType: document.getElementById('tradeType').value,
        symbol: document.getElementById('symbol').value,
        setupType: document.getElementById('setupType').value,
        trendM15: document.getElementById('trendM15').value,
        trendM30: document.getElementById('trendM30').value,
        trendH1: document.getElementById('trendH1').value,
        trendH4: document.getElementById('trendH4').value,
        trendD1: document.getElementById('trendD1').value,
        trendMN: document.getElementById('trendMN').value,
        entryPrice: document.getElementById('entryPrice').value,
        stopLoss: document.getElementById('stopLoss').value,
        takeProfit: document.getElementById('takeProfit').value,
        riskAmount: document.getElementById('riskAmount').value,
        riskReward: document.getElementById('riskReward').value,
        tradeResult: document.getElementById('tradeResult').value,
        profitLoss: document.getElementById('profitLoss').value,
        mentalState: document.getElementById('mentalState').value,
        reasonEntry: document.getElementById('reasonEntry').value,
        emotions: document.getElementById('emotions').value,
        mistakes: document.getElementById('mistakes').value,
        improvements: document.getElementById('improvements').value,
        description: document.getElementById('description').value
    };
}

function validate(trade){
    return trade.datetime && trade.tradeType && trade.setupType && trade.trendM15 && trade.riskAmount && trade.tradeResult && trade.mentalState && trade.reasonEntry;
}

/* ======= Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ Ùˆ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ======= */
function persistLocal(){
    localStorage.setItem('xauusdTrades', JSON.stringify(trades));
}

/* debounce push: Ù¾Ø³ Ø§Ø² Ù‡Ø± Ø°Ø®ÛŒØ±Ù‡/ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø§Ú¯Ø± autoPush ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ØŒ push Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ */
function scheduleAutoPush(){
    const enabled = document.getElementById('autoPush').checked;
    if(!enabled) return;
    if(autoPushTimer) clearTimeout(autoPushTimer);
    autoPushTimer = setTimeout(()=> {
        saveToGist().catch(()=>{/* Ø®Ø·Ø§Ù‡Ø§ Ø¯Ø± Ø¯Ø§Ø®Ù„ ØªØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ */});
    }, PUSH_DEBOUNCE_MS);
}

/* Ù…Ø¯ÛŒØ±ÛŒØª Auto Pull Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ */
function startAutoPull(minutes){
    stopAutoPull();
    const ms = Math.max(1, minutes) * 60 * 1000;
    autoPullIntervalId = setInterval(()=> {
        const token = document.getElementById('gistToken').value.trim() || localStorage.getItem('xau_gist_token') || '';
        const gistId = document.getElementById('gistId').value.trim() || localStorage.getItem('xau_gist_id') || '';
        if(token && gistId){
            fetch(`https://api.github.com/gists/${gistId}`, { method:'GET', headers: { 'Authorization': 'token ' + token } })
            .then(res => {
                if(!res.ok) throw new Error('Gist load failed');
                return res.json();
            })
            .then(data => {
                const file = data.files && (data.files['xauusd_trades.json'] || data.files[Object.keys(data.files)[0]]);
                if(!file || !file.content) return;
                try{
                    const remote = JSON.parse(file.content);
                    if(!Array.isArray(remote)) return;
                    // Merge Ø³Ø§Ø¯Ù‡: Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ remote Ú©Ù‡ id Ù†Ø¯Ø§Ø±Ù†Ø¯ ÛŒØ§ id Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø±Ù†Ø¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    let changed = false;
                    const localIds = new Set(trades.map(t=>t.id));
                    remote.forEach(r => {
                        if(!r.id || !localIds.has(r.id)){
                            trades.push({ ...r, id: r.id || (Date.now()+Math.random()) });
                            changed = true;
                        }
                    });
                    if(changed){
                        persistLocal();
                        if(filteredTrades!==null) applyFilter(); else updateTable();
                        updateStats();
                        showAlert('ğŸ”„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Gist Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù†Ø¯ (merge Ø®ÙˆØ¯Ú©Ø§Ø±)','info');
                    }
                }catch(e){ /* ignore parse errors */ }
            })
            .catch(()=>{/* ignore auto-pull errors silently */});
        }
    }, ms);
}

function stopAutoPull(){
    if(autoPullIntervalId) { clearInterval(autoPullIntervalId); autoPullIntervalId = null; }
}

/* ======= Ø¹Ù…Ù„ÛŒØ§Øª CRUD ======= */
function saveTrade(){
    const payload = readForm();
    if(!validate(payload)){ showAlert('Ù„Ø·ÙØ§Ù‹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯','error'); return; }
    const trade = { id: Date.now(), ...payload };
    trades.push(trade);
    persistLocal();
    selectedRowId = trade.id;
    updateTable(); updateStats();
    showAlert('âœ… Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!','success');
    scheduleAutoPush();
}

function updateTrade(){
    if(selectedRowId === null){ showAlert('Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª','error'); return; }
    const payload = readForm();
    if(!validate(payload)){ showAlert('Ù„Ø·ÙØ§Ù‹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯','error'); return; }
    const idx = trades.findIndex(t => t.id === selectedRowId);
    if(idx === -1){ showAlert('Ø±Ú©ÙˆØ±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯','error'); return; }
    trades[idx] = { ...trades[idx], ...payload };
    persistLocal();
    if(filteredTrades!==null) applyFilter(); else updateTable();
    updateStats();
    showAlert('ğŸ› ï¸ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯','success');
    scheduleAutoPush();
}

function deleteTrade(id){
    if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
    trades = trades.filter(t=>t.id!==id);
    if(selectedRowId === id) clearForm();
    persistLocal();
    if(filteredTrades!==null) applyFilter(); else { updateTable(); updateStats(); }
    showAlert('Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø­Ø°Ù Ø´Ø¯','info');
    scheduleAutoPush();
}

function clearForm(){
    document.querySelectorAll('input, select, textarea').forEach(el=>el.value='');
    selectedRowId = null;
    updateTable();
}

/* ======= Ø¬Ø¯ÙˆÙ„ Ùˆ Ø¢Ù…Ø§Ø± ======= */
function getActiveList(){ return filteredTrades !== null ? filteredTrades : trades; }

function updateTable(){
    const tbody = document.getElementById('tradesTable');
    const list = getActiveList();
    if(list.length === 0){
        tbody.innerHTML = `<tr><td colspan="16" style="text-align:center;padding:40px;color:#95a5a6">Ù‡Ù†ÙˆØ² Ù…Ø¹Ø§Ù…Ù„Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>`;
        return;
    }
    tbody.innerHTML = list.map(trade=>{
        const pl = parseFloat(trade.profitLoss) || 0;
        const plClass = pl>0 ? 'profit' : pl<0 ? 'loss' : '';
        const plSign = pl>0 ? '+' : '';
        const isSelected = trade.id === selectedRowId ? 'selected-row' : '';
        return `
            <tr class="${isSelected}" data-id="${trade.id}" onclick="selectTrade(${trade.id})">
                <td>${formatDateTime(trade.datetime)}</td>
                <td>${trade.tradeType}</td>
                <td>${trade.symbol || '-'}</td>
                <td>${trade.setupType}</td>
                <td>${trade.trendM15||'-'}</td>
                <td>${trade.trendM30||'-'}</td>
                <td>${trade.trendH1||'-'}</td>
                <td>${trade.trendH4||'-'}</td>
                <td>${trade.trendD1||'-'}</td>
                <td>${trade.trendMN||'-'}</td>
                <td>$${trade.riskAmount}</td>
                <td>${trade.riskReward || '-'}</td>
                <td>${trade.tradeResult}</td>
                <td class="${plClass}">${plSign}$${(trade.profitLoss||0)}</td>
                <td>${trade.description ? trade.description.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '-'}</td>
                <td><button class="delete-btn" onclick="event.stopPropagation(); deleteTrade(${trade.id})">Ø­Ø°Ù</button></td>
            </tr>
        `;
    }).join('');
}

function selectTrade(id){
    const list = getActiveList();
    const trade = list.find(t => t.id === id);
    if(!trade) return;
    selectedRowId = id;
    document.getElementById('datetime').value = trade.datetime || '';
    document.getElementById('tradeType').value = trade.tradeType || '';
    document.getElementById('symbol').value = trade.symbol || '';
    document.getElementById('setupType').value = trade.setupType || '';
    document.getElementById('trendM15').value = trade.trendM15 || '';
    document.getElementById('trendM30').value = trade.trendM30 || '';
    document.getElementById('trendH1').value = trade.trendH1 || '';
    document.getElementById('trendH4').value = trade.trendH4 || '';
    document.getElementById('trendD1').value = trade.trendD1 || '';
    document.getElementById('trendMN').value = trade.trendMN || '';
    document.getElementById('entryPrice').value = trade.entryPrice || '';
    document.getElementById('stopLoss').value = trade.stopLoss || '';
    document.getElementById('takeProfit').value = trade.takeProfit || '';
    document.getElementById('riskAmount').value = trade.riskAmount || '';
    document.getElementById('riskReward').value = trade.riskReward || '';
    document.getElementById('tradeResult').value = trade.tradeResult || '';
    document.getElementById('profitLoss').value = trade.profitLoss || '';
    document.getElementById('mentalState').value = trade.mentalState || '';
    document.getElementById('reasonEntry').value = trade.reasonEntry || '';
    document.getElementById('emotions').value = trade.emotions || '';
    document.getElementById('mistakes').value = trade.mistakes || '';
    document.getElementById('improvements').value = trade.improvements || '';
    document.getElementById('description').value = trade.description || '';
    updateTable();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateStats(){
    const list = getActiveList();
    const total = list.length;
    const winning = list.filter(t=>parseFloat(t.profitLoss)>0).length;
    const losing = list.filter(t=>parseFloat(t.profitLoss)<0).length;
    const winRate = total>0 ? ((winning/total)*100).toFixed(1) : 0;
    const totalPL = list.reduce((s,t)=>s + (parseFloat(t.profitLoss)||0),0).toFixed(2);
    document.getElementById('totalTrades').textContent = total;
    document.getElementById('winningTrades').textContent = winning;
    document.getElementById('losingTrades').textContent = losing;
    document.getElementById('winRate').textContent = winRate + '%';
    const plEl = document.getElementById('totalPL');
    plEl.textContent = '$' + totalPL;
    plEl.className = totalPL>0 ? 'profit' : totalPL<0 ? 'loss' : '';
}

/* ======= ÙÛŒÙ„ØªØ± ØªØ§Ø±ÛŒØ® ======= */
function applyFilter(){
    const from = document.getElementById('fromDate').value;
    const to = document.getElementById('toDate').value;
    if(!from && !to){ showAlert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ©ÛŒ Ø§Ø² Ø¯Ùˆ ØªØ§Ø±ÛŒØ® Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
    const fromTS = from ? new Date(from + 'T00:00:00').getTime() : -Infinity;
    const toTS = to ? new Date(to + 'T23:59:59').getTime() : Infinity;
    filteredTrades = trades.filter(t=>{
        if(!t.datetime) return false;
        const ts = new Date(t.datetime).getTime();
        return ts >= fromTS && ts <= toTS;
    });
    document.getElementById('currentFilter').textContent = (from?('Ø§Ø² '+from):'') + (to?(' ØªØ§ '+to):'');
    if(filteredTrades && !filteredTrades.some(t => t.id === selectedRowId)) selectedRowId = null;
    updateTable(); updateStats();
    showAlert(`âœ… ${filteredTrades.length} Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ ÛŒØ§ÙØª Ø´Ø¯`,'success');
}

function resetFilter(){
    filteredTrades = null;
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    document.getElementById('currentFilter').textContent = '';
    updateTable(); updateStats();
    showAlert('Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª','info');
}

/* ======= Excel / PDF / Import ======= */
function exportToExcel(){
    const list = getActiveList();
    if(list.length===0){ showAlert('Ù‡ÛŒÚ† Ù…Ø¹Ø§Ù…Ù„Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!','error'); return; }
    const worksheet_data = [
        ['ØªØ§Ø±ÛŒØ®','Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡','Ù†Ù…Ø§Ø¯','Ù†ÙˆØ¹ Ø³ØªØ§Ù¾','M15','M30','H1','H4','D1','MN','Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯','Ø­Ø¯ Ø¶Ø±Ø±','Ø­Ø¯ Ø³ÙˆØ¯','Ø±ÛŒØ³Ú© ($)','R:R','Ù†ØªÛŒØ¬Ù‡','Ø³ÙˆØ¯/Ø¶Ø±Ø± ($)','Ø­Ø§Ù„Øª Ø°Ù‡Ù†ÛŒ','Ø¯Ù„ÛŒÙ„ ÙˆØ±ÙˆØ¯','ØªÙˆØ¶ÛŒØ­Ø§Øª']
    ];
    list.forEach(t=>{
        worksheet_data.push([
            formatDateTime(t.datetime),
            t.tradeType, t.symbol || '', t.setupType, t.trendM15 || '', t.trendM30 || '', t.trendH1 || '', t.trendH4 || '', t.trendD1 || '', t.trendMN || '',
            t.entryPrice || '', t.stopLoss || '', t.takeProfit || '', t.riskAmount, t.riskReward || '', t.tradeResult, t.profitLoss || '0', t.mentalState || '', t.reasonEntry || '', t.description || ''
        ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(worksheet_data);
    ws['!cols'] = new Array(worksheet_data[0].length).fill({wch:18});
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Ù…Ø¹Ø§Ù…Ù„Ø§Øª');
    const fileName = `XAUUSD_Journal_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showAlert('âœ… ÙØ§ÛŒÙ„ Excel Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!','success');
}

async function exportToPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt',format:'a4'});
    const list = getActiveList();
    if(list.length===0){ showAlert('Ù‡ÛŒÚ† Ù…Ø¹Ø§Ù…Ù„Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!','error'); return; }
    const head = [['ØªØ§Ø±ÛŒØ®','Ù†ÙˆØ¹','Ù†Ù…Ø§Ø¯','Ø³ØªØ§Ù¾','M15','M30','H1','H4','D1','MN','Ø±ÛŒØ³Ú©','R:R','Ù†ØªÛŒØ¬Ù‡','Ø³ÙˆØ¯/Ø¶Ø±Ø±','ØªÙˆØ¶ÛŒØ­Ø§Øª']];
    const body = list.map(t => [
        formatDateTime(t.datetime),
        t.tradeType, t.symbol || '-', t.setupType, t.trendM15||'-', t.trendM30||'-', t.trendH1||'-', t.trendH4||'-', t.trendD1||'-', t.trendMN||'-',
        '$'+(t.riskAmount||''), t.riskReward||'-', t.tradeResult, (t.profitLoss||0), (t.description||'')
    ]);
    doc.setFontSize(10);
    doc.text('Ú˜ÙˆØ±Ù†Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ XAUUSD',40,40);
    doc.autoTable({ head: head, body: body, startY: 60, styles:{ font:'helvetica', fontSize:9, halign:'right' }, headStyles:{ fillColor:[102,126,234] }, margin:{left:20,right:20} });
    const fileName = `XAUUSD_Journal_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    showAlert('âœ… Ø®Ø±ÙˆØ¬ÛŒ PDF Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯','success');
}

function importFromExcel(event){
    const file = event.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
        try{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{type:'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            if(jsonData.length===0){ showAlert('ÙØ§ÛŒÙ„ Excel Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!','error'); return; }
            if(confirm(`Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ${jsonData.length} Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ØŸ (Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø­ÙØ¸ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)`)){
                jsonData.forEach(row=>{
                    const trade = {
                        id: Date.now()+Math.random(),
                        datetime: row['ØªØ§Ø±ÛŒØ®'] || row['Date'] || '',
                        tradeType: row['Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡'] || row['Type'] || '',
                        symbol: row['Ù†Ù…Ø§Ø¯'] || row['Symbol'] || '',
                        setupType: row['Ù†ÙˆØ¹ Ø³ØªØ§Ù¾'] || row['Setup'] || '',
                        trendM15: row['M15'] || row['Ø±ÙˆÙ†Ø¯ M15'] || '',
                        trendM30: row['M30'] || '',
                        trendH1: row['H1'] || '',
                        trendH4: row['H4'] || '',
                        trendD1: row['D1'] || '',
                        trendMN: row['MN'] || '',
                        entryPrice: row['Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯'] || '',
                        stopLoss: row['Ø­Ø¯ Ø¶Ø±Ø±'] || '',
                        takeProfit: row['Ø­Ø¯ Ø³ÙˆØ¯'] || '',
                        riskAmount: row['Ø±ÛŒØ³Ú© ($)'] || row['Risk'] || '',
                        riskReward: row['R:R'] || '',
                        tradeResult: row['Ù†ØªÛŒØ¬Ù‡'] || '',
                        profitLoss: row['Ø³ÙˆØ¯/Ø¶Ø±Ø± ($)'] || row['PL'] || '0',
                        mentalState: row['Ø­Ø§Ù„Øª Ø°Ù‡Ù†ÛŒ'] || '',
                        reasonEntry: row['Ø¯Ù„ÛŒÙ„ ÙˆØ±ÙˆØ¯'] || '',
                        description: row['ØªÙˆØ¶ÛŒØ­Ø§Øª'] || row['Description'] || ''
                    };
                    trades.push(trade);
                });
                persistLocal();
                if(filteredTrades!==null) applyFilter(); else { updateTable(); updateStats(); }
                showAlert(`âœ… ${jsonData.length} Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯!`,'success');
                scheduleAutoPush();
            }
        }catch(err){
            console.error(err);
            showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Excel!','error');
        }
    };
    reader.readAsArrayBuffer(file);
    event.target.value='';
}

/* ======= GitHub Gist API ======= */
function saveGistConfig(){
    const token = document.getElementById('gistToken').value.trim();
    const gistId = document.getElementById('gistId').value.trim();
    if(token) localStorage.setItem('xau_gist_token', token); else localStorage.removeItem('xau_gist_token');
    if(gistId) localStorage.setItem('xau_gist_id', gistId); else localStorage.removeItem('xau_gist_id');

    // Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª auto
    const autoPush = document.getElementById('autoPush').checked;
    const autoPull = document.getElementById('autoPull').checked;
    const pullInterval = parseInt(document.getElementById('pullInterval').value || DEFAULT_PULL_MINUTES, 10);
    localStorage.setItem('xau_auto_push', autoPush ? '1' : '0');
    localStorage.setItem('xau_auto_pull', autoPull ? '1' : '0');
    localStorage.setItem('xau_pull_interval', String(pullInterval));

    // Ù…Ø¯ÛŒØ±ÛŒØª autoPull
    if(autoPull) startAutoPull(pullInterval); else stopAutoPull();

    showAlert('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Gist Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯','success');
}

function clearGistConfig(){
    localStorage.removeItem('xau_gist_token');
    localStorage.removeItem('xau_gist_id');
    localStorage.removeItem('xau_auto_push');
    localStorage.removeItem('xau_auto_pull');
    localStorage.removeItem('xau_pull_interval');
    document.getElementById('gistToken').value = '';
    document.getElementById('gistId').value = '';
    document.getElementById('autoPush').checked = true;
    document.getElementById('autoPull').checked = true;
    document.getElementById('pullInterval').value = DEFAULT_PULL_MINUTES;
    stopAutoPull();
    showAlert('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Gist Ù¾Ø§Ú© Ø´Ø¯','info');
}

async function createGist(){
    const token = document.getElementById('gistToken').value.trim();
    if(!token){ showAlert('Ø§Ø¨ØªØ¯Ø§ ØªÙˆÚ©Ù† GitHub Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
    const content = JSON.stringify(trades, null, 2);
    const body = { description: "XAUUSD trades backup (created by journal app)", public: false, files: { "xauusd_trades.json": { content } } };
    try{
        const res = await fetch('https://api.github.com/gists', {
            method: 'POST',
            headers: { 'Authorization': 'token ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if(!res.ok){ const txt = await res.text(); throw new Error('GitHub API error: ' + res.status + ' ' + txt); }
        const data = await res.json();
        const id = data.id;
        document.getElementById('gistId').value = id;
        localStorage.setItem('xau_gist_id', id);
        localStorage.setItem('xau_gist_token', token);
        showAlert('âœ… Gist Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯','success');
    }catch(err){
        console.error(err);
        showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Gist. ØªÙˆÚ©Ù† ÛŒØ§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª API Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯','error');
    }
}

async function saveToGist(){
    const token = document.getElementById('gistToken').value.trim() || localStorage.getItem('xau_gist_token') || '';
    let gistId = document.getElementById('gistId').value.trim() || localStorage.getItem('xau_gist_id') || '';
    if(!token){ showAlert('ØªÙˆÚ©Ù† GitHub Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
    if(!gistId){
        if(!confirm('Ù‡ÛŒÚ† Gist ID Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡. Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÛŒÚ© Gist Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´ÙˆØ¯ØŸ')) return;
        await createGist();
        gistId = document.getElementById('gistId').value.trim();
        if(!gistId) return;
    }
    const content = JSON.stringify(trades, null, 2);
    const body = { files: { "xauusd_trades.json": { content } } };
    try{
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
            method: 'PATCH',
            headers: { 'Authorization': 'token ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if(!res.ok){ const txt = await res.text(); throw new Error('GitHub API error: ' + res.status + ' ' + txt); }
        localStorage.setItem('xau_gist_token', token);
        localStorage.setItem('xau_gist_id', gistId);
        showAlert('âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Gist Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯','success');
    }catch(err){
        console.error(err);
        showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Gist. Ø´Ù†Ø§Ø³Ù‡ ÛŒØ§ ØªÙˆÚ©Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯','error');
    }
}

async function loadFromGist(){
    const token = document.getElementById('gistToken').value.trim() || localStorage.getItem('xau_gist_token') || '';
    const gistId = document.getElementById('gistId').value.trim() || localStorage.getItem('xau_gist_id') || '';
    if(!token || !gistId){ showAlert('ØªÙˆÚ©Ù† Ùˆ Gist ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
    try{
        const res = await fetch(`https://api.github.com/gists/${gistId}`, { method: 'GET', headers: { 'Authorization': 'token ' + token } });
        if(!res.ok){ const txt = await res.text(); throw new Error('GitHub API error: ' + res.status + ' ' + txt); }
        const data = await res.json();
        const file = data.files && (data.files['xauusd_trades.json'] || data.files[Object.keys(data.files)[0]]);
        if(!file || !file.content){ showAlert('ÙØ§ÛŒÙ„ xauusd_trades.json Ø¯Ø± Gist Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯','error'); return; }
        const remote = JSON.parse(file.content);
        if(!Array.isArray(remote)){ showAlert('Ù…Ø­ØªÙˆØ§ÛŒ Gist Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª (Ø¢Ø±Ø§ÛŒÙ‡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù†ØªØ¸Ø§Ø± Ù…ÛŒâ€ŒØ±ÙˆØ¯)','error'); return; }
        if(!confirm(`Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ${remote.length} Ø±Ú©ÙˆØ±Ø¯ Ø§Ø² Gist Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯ØŸ (Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯)`)) return;
        trades = remote.map(r => ({ ...r, id: r.id || (Date.now()+Math.random()) }));
        persistLocal();
        filteredTrades = null;
        selectedRowId = null;
        updateTable(); updateStats();
        showAlert('âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Gist Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯','success');
    }catch(err){
        console.error(err);
        showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Gist. Ø´Ù†Ø§Ø³Ù‡ ÛŒØ§ ØªÙˆÚ©Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯','error');
    }
}

/* ======= Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ======= */
loadTrades();

/* ======= Ø±ÙØªØ§Ø± UI: Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Auto push/pull Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± ======= */
document.getElementById('autoPush').addEventListener('change', ()=> {
    localStorage.setItem('xau_auto_push', document.getElementById('autoPush').checked ? '1' : '0');
    showAlert('ØªÙ†Ø¸ÛŒÙ… Autoâ€‘push Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯','info');
});
document.getElementById('autoPull').addEventListener('change', ()=> {
    const enabled = document.getElementById('autoPull').checked;
    localStorage.setItem('xau_auto_pull', enabled ? '1' : '0');
    const minutes = parseInt(document.getElementById('pullInterval').value || DEFAULT_PULL_MINUTES, 10);
    if(enabled) startAutoPull(minutes); else stopAutoPull();
    showAlert('ØªÙ†Ø¸ÛŒÙ… Autoâ€‘pull Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯','info');
});
document.getElementById('pullInterval').addEventListener('change', ()=> {
    const minutes = parseInt(document.getElementById('pullInterval').value || DEFAULT_PULL_MINUTES, 10);
    localStorage.setItem('xau_pull_interval', String(minutes));
    if(document.getElementById('autoPull').checked) startAutoPull(minutes);
    showAlert('ÙØ§ØµÙ„Ù‡ Autoâ€‘pull Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯','info');
});
</script>
</body>
</html>
